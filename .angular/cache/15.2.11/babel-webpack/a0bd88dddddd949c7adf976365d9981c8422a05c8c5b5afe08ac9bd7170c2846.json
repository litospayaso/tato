{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/AngelHita/Documents/tato/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { EndingsModalComponent } from '@components/endings-modal/endings-modal.component';\nimport { PromotionModalComponent } from '@components/promotion-modal/promotion-modal.component';\nimport { PuzzlesModalComponent } from '@components/puzzles-modal/puzzles-modal.component';\nimport { Stockfish } from '@classes/stockfish';\nimport * as uuid from 'uuid';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ionic/angular\";\nimport * as i2 from \"@services/request.service\";\nimport * as i3 from \"@services/games.service\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@pipes/translate.pipe\";\nexport let EndingsPage = /*#__PURE__*/(() => {\n  class EndingsPage {\n    constructor(popoverController, requestService, modalController, gameService) {\n      this.popoverController = popoverController;\n      this.requestService = requestService;\n      this.modalController = modalController;\n      this.gameService = gameService;\n      this.turn = 'w';\n      this.puzzlesToMakeANewRequest = 10;\n      this.failed = false;\n      this.theme = 'all';\n      this.dificulty = 'Medium';\n      this.stockfish = new Stockfish(20, 12, 3);\n      this.stockfish.emmiter = this.stockfishEmmiter.bind(this);\n    }\n    ngAfterViewInit() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        _this.boardId = uuid.v4();\n        _this.userRating = _this.gameService.getUserRating();\n        const defaultEndingsValues = _this.gameService.getDefaultEndingsValues();\n        if (defaultEndingsValues) {\n          _this.dificulty = defaultEndingsValues.dificulty;\n          _this.theme = defaultEndingsValues.theme;\n        }\n        const modal = yield _this.modalController.create({\n          component: EndingsModalComponent,\n          componentProps: {\n            defaultEndingsValues: {\n              theme: _this.theme,\n              dificulty: _this.dificulty\n            }\n          }\n        });\n        yield modal.present();\n        yield modal.onDidDismiss().then(data => {\n          if (data.data) {\n            _this.gameService.setDefaultEndingValues(data.data);\n            _this.theme = data.data.theme;\n            _this.dificulty = data.data.dificulty;\n            _this.setEndingData();\n          }\n        });\n      })();\n    }\n    setEndingData() {\n      if (this.theme === 'all') {\n        this.requestService.getEndingsFromTheme(this.dificulty).subscribe(data => {\n          this.allEndings = data;\n          this.currentEnding = this.allEndings.splice(Math.floor(Math.random() * this.allEndings.length), 1)[0];\n          this.initPosition();\n        });\n      } else {\n        this.requestService.getEndingsFromTheme(this.theme).subscribe(data => {\n          this.allEndings = this.theme !== 'draw' ? data.filter(e => e.theme.includes(this.dificulty)) : data;\n          this.currentEnding = this.allEndings.splice(Math.floor(Math.random() * this.allEndings.length), 1)[0];\n          this.initPosition();\n        });\n      }\n    }\n    initPosition() {\n      this.failed = false;\n      this.game = new Chess(this.currentEnding.fen);\n      this.moves = '';\n      this.userColor = this.currentEnding.fen.split(' ')[1] === 'w' ? 'black' : 'white';\n      this.board = Chessground(document.getElementById(this.boardId), {\n        orientation: this.userColor,\n        fen: this.currentEnding.fen,\n        turnColor: this.userColor,\n        movable: {\n          color: this.userColor,\n          free: false,\n          dests: this.toDests()\n        },\n        draggable: {\n          showGhost: true\n        }\n      });\n      this.board.set({\n        movable: {\n          events: {\n            after: this.makeAMove()\n          }\n        }\n      });\n      this.stockfish.evalFen(this.game.fen());\n      setTimeout(() => {\n        // this.makeComputerMove(this.currentEnding);\n      }, 1000);\n    }\n    makeAMove() {\n      var _this2 = this;\n      return /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* (orig, dest) {\n          let move = `${orig}${dest}`;\n          const origPiece = _this2.game.get(orig);\n          if (origPiece.type === 'p' && (origPiece.color === 'w' && dest.includes('8') || origPiece.color === 'b' && dest.includes('1'))) {\n            const popover = yield _this2.popoverController.create({\n              component: PromotionModalComponent,\n              componentProps: {\n                color: `modal-color-${origPiece.color}`\n              },\n              translucent: false\n            });\n            yield popover.present();\n            const promotion = yield popover.onDidDismiss();\n            yield popover.present();\n            move = move.concat(promotion.data);\n          }\n          const moves = _this2.moves.concat(` ${move}`);\n          _this2.moves = moves;\n          // this.moves = this.game.history({verbose: true}).map(e => `${e.from}${e.to}${e.promotion ? e.promotion : ''}`).join(' ');\n          _this2.game.move(move, {\n            sloppy: true\n          });\n          _this2.board.set({\n            check: _this2.game.in_check() ? _this2.userColor === 'white' ? 'black' : 'white' : false\n          });\n          _this2.turn = _this2.game.turn();\n          if (_this2.game.in_checkmate() || _this2.game.in_draw() || _this2.game.in_stalemate() || _this2.game.in_threefold_repetition()) {\n            setTimeout(() => {\n              _this2.endGame();\n            }, 1500);\n          }\n          _this2.stockfish.evalFen(_this2.game.fen());\n        });\n        return function (_x, _x2) {\n          return _ref.apply(this, arguments);\n        };\n      }();\n    }\n    makeMove(move) {\n      this.game.move(move, {\n        sloppy: true\n      });\n      const moves = this.moves.concat(` ${move}`);\n      this.moves = moves;\n      // this.moves = this.game.history({verbose: true}).map(e => `${e.from}${e.to}${e.promotion ? e.promotion : ''}`).join(' ');\n      this.turn = this.game.turn();\n      this.board.set({\n        fen: this.game.fen(),\n        check: this.game.in_check() ? this.userColor : false,\n        turnColor: this.toColor(),\n        movable: {\n          color: this.toColor(),\n          dests: this.toDests()\n        }\n      });\n      if (this.game.in_checkmate() || this.game.in_draw() || this.game.in_stalemate() || this.game.in_threefold_repetition()) {\n        setTimeout(() => {\n          this.endGame();\n        }, 1500);\n      }\n    }\n    toColor() {\n      return this.game.turn() === 'w' ? 'white' : 'black';\n    }\n    toDests() {\n      const dests = new Map();\n      this.game.SQUARES.forEach(s => {\n        const ms = this.game.moves({\n          square: s,\n          verbose: true\n        });\n        if (ms.length) {\n          dests.set(s, ms.map(m => m.to));\n        }\n      });\n      return dests;\n    }\n    openSettings() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        const modal = yield _this3.modalController.create({\n          component: PuzzlesModalComponent,\n          componentProps: {\n            theme: _this3.theme\n          }\n        });\n        yield modal.present();\n        yield modal.onDidDismiss().then(data => {\n          if (data.data) {\n            _this3.theme = data.data.theme;\n            _this3.setEndingData();\n          }\n        });\n      })();\n    }\n    stockfishEmmiter(event) {\n      if (event === 'bestmove') {\n        if (this.stockfish.bestmove || this.moves === '') {\n          const turn = this.game.turn() === 'w' ? 'white' : 'black';\n          if (turn !== this.userColor) {\n            this.makeMove(this.stockfish.bestmove);\n          }\n        }\n      }\n    }\n    endGame() {\n      this.currentEnding = this.allEndings.splice(Math.floor(Math.random() * this.allEndings.length), 1)[0];\n      this.initPosition();\n    }\n    static #_ = this.ɵfac = function EndingsPage_Factory(t) {\n      return new (t || EndingsPage)(i0.ɵɵdirectiveInject(i1.PopoverController), i0.ɵɵdirectiveInject(i2.RequestService), i0.ɵɵdirectiveInject(i1.ModalController), i0.ɵɵdirectiveInject(i3.GamesService));\n    };\n    static #_2 = this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: EndingsPage,\n      selectors: [[\"app-endings\"]],\n      decls: 18,\n      vars: 12,\n      consts: [[3, \"fullscreen\"], [1, \"title-bar\"], [1, \"title-bar-text\"], [1, \"title-bar-controls\"], [\"aria-label\", \"Minimize\"], [\"aria-label\", \"Maximize\"], [\"aria-label\", \"Close\"], [1, \"panel-container\"], [1, \"board-container\"], [3, \"id\"], [1, \"control-buttons-container\"], [\"color\", \"medium\", 1, \"windows-button\", \"button-control-element\", 3, \"click\"]],\n      template: function EndingsPage_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵelementStart(0, \"ion-content\", 0)(1, \"div\", 1)(2, \"div\", 2);\n          i0.ɵɵtext(3);\n          i0.ɵɵpipe(4, \"async\");\n          i0.ɵɵpipe(5, \"translate\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(6, \"div\", 3);\n          i0.ɵɵelement(7, \"button\", 4)(8, \"button\", 5)(9, \"button\", 6);\n          i0.ɵɵelementEnd()();\n          i0.ɵɵelementStart(10, \"div\", 7)(11, \"div\", 8);\n          i0.ɵɵelement(12, \"div\", 9);\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(13, \"div\", 10)(14, \"button\", 11);\n          i0.ɵɵlistener(\"click\", function EndingsPage_Template_button_click_14_listener() {\n            return ctx.endGame();\n          });\n          i0.ɵɵtext(15);\n          i0.ɵɵpipe(16, \"async\");\n          i0.ɵɵpipe(17, \"translate\");\n          i0.ɵɵelementEnd()()()();\n        }\n        if (rf & 2) {\n          i0.ɵɵproperty(\"fullscreen\", true);\n          i0.ɵɵadvance(3);\n          i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(4, 4, i0.ɵɵpipeBind1(5, 6, \"endings\")));\n          i0.ɵɵadvance(9);\n          i0.ɵɵproperty(\"id\", ctx.boardId);\n          i0.ɵɵadvance(3);\n          i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(16, 8, i0.ɵɵpipeBind1(17, 10, \"resign\")), \" \");\n        }\n      },\n      dependencies: [i1.IonContent, i4.AsyncPipe, i5.TranslatePipe],\n      styles: [\".title-bar[_ngcontent-%COMP%]{background:linear-gradient(90deg,#000080,#1084d0);padding:3px 6px;display:flex;justify-content:space-between;align-items:center;margin:0 auto;position:relative;top:5px;width:calc(65vmin - 6px)}@media (max-width: 660px){.title-bar[_ngcontent-%COMP%]{width:unset;margin:0 13px}}.title-bar[_ngcontent-%COMP%]   .title-bar-text[_ngcontent-%COMP%]{color:#fff;font-weight:700;font-size:12px;margin-right:24px}.title-bar[_ngcontent-%COMP%]   .title-bar-controls[_ngcontent-%COMP%]{display:flex}.title-bar[_ngcontent-%COMP%]   .title-bar-controls[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:16px;height:14px;border:none;background-color:silver;margin-left:2px;position:relative;box-shadow:inset -1px -1px #0a0a0a,inset 1px 1px #fff,inset -2px -2px gray,inset 2px 2px #dfdfdf}.panel-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;flex-wrap:wrap;background-color:silver;border:2px solid #dfdfdf;border-bottom-color:#404040;border-right-color:#404040;width:65vmin;box-shadow:inset 1px 1px #dfdfdf,1px 0 #000,0 1px #000,1px 1px #000;margin:-24px auto 10px;padding:36px 25px 0}@media (max-width: 660px){.panel-container[_ngcontent-%COMP%]{width:unset;flex-direction:column;margin:-24px 10px 10px;padding:36px 18px 10px 10px}}.panel-container[_ngcontent-%COMP%]   .board-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;width:65vmin;height:65vmin;margin:10px}@media (max-width: 660px){.panel-container[_ngcontent-%COMP%]   .board-container[_ngcontent-%COMP%]{width:calc(100vmin - 50px);height:calc(100vmin - 50px);margin:0 0 85px}}.panel-container[_ngcontent-%COMP%]   .board-container-element[_ngcontent-%COMP%]{width:55vmin;height:55vmin}.panel-container[_ngcontent-%COMP%]   .panel-element[_ngcontent-%COMP%]{width:calc(100vw - 68vmin - 55px);margin:20px auto;overflow-y:auto;max-height:calc(100vh - 135px)}@media (max-width: 660px){.panel-container[_ngcontent-%COMP%]   .panel-element[_ngcontent-%COMP%]{width:100%;padding:0 5px;max-height:calc(100vh - 100vmin - 185px);overflow-y:auto}}.control-buttons-container[_ngcontent-%COMP%]{margin-top:-35px;display:flex;flex-direction:row;width:100%;margin-bottom:18px}.control-buttons-container[_ngcontent-%COMP%]   .button-control-element[_ngcontent-%COMP%]{width:100%}@media (max-width: 660px){.control-buttons-container[_ngcontent-%COMP%]{width:calc(100vmin - 50px)}}\"]\n    });\n  }\n  return EndingsPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}